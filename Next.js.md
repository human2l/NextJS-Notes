## Start a new project

`npx create-next-app` or `yarn create-next-app`

`npx` is a node package runner to run node executable

## Upgrade Next.js version

1. `npm install react@latest react-dom@latest`

2. `npm audit`

3. Check the high vulnerabilities, then fix it

4. `npm audit fix`

5. keep doing step 2-4 till all of vulnerabilities fixed

Resource: https://nextjs.org/docs/upgrading

## Next.js project folder structure

<img src="Next.js.assets/Screen Shot 2022-03-18 at 12.55.44 PM.png" alt="Screen Shot 2022-03-18 at 12.55.44 PM" style="zoom:50%;" />

### Pages:

Next.js will create a router for files in `/pages` base on file name

`_app.js` is the entry of project, is a wrapper of our app, we may add global features here, i.e. footer

## CSS Module

`*.module.css`

Any file with surfix ".module.css" is a css module. each module have a scope base on file name. i.e. "Home.module.css" is scope to "home" component.

css module will not affect pages outside its scope. i.e. `.container` in one module will **not overwrite** `.container` in another one. This because each class will be given a unique name.

<img src="Next.js.assets/Screen Shot 2022-03-17 at 11.08.59 AM.png" alt="Screen Shot 2022-03-17 at 11.08.59 AM" style="zoom:50%;" />

all styles in `module.css` will be export as object. and be inported to the page.

```css
.container {
	color: red;
}
```

```react
import styles from "../styles/hello.module.css"
const hello = () => {
	return <div className={style.container}>Hello World</div>;
}
export default Hello
```

## Mobile-First Strategy

Whenever create any website and app, we should start sketching, prototyping and coding the smallest screen first

Reference: https://css-tricks.com/how-to-develop-and-test-a-mobile-first-design-in-2021/

## Device Width

```css
sm: min-width: 640px; //small device
md: min-width: 768px; // medium device
lg: min-width: 1024px; // large device
xl: min-width: 1280px; // extra large device
2xl: min-width: 1536px; // 2 x extra large device
```

## Head Component

`import Head from "next/head";`

```jsx
<Head>
  <title>Create Next App</title>
  <meta name="description" content="Generated by create next app" />
  <link rel="icon" href="/favicon.ico" />
</Head>
```

# Routing

<img src="Next.js.assets/Screen Shot 2022-03-18 at 12.58.57 PM.png" alt="Screen Shot 2022-03-18 at 12.58.57 PM" style="zoom:50%;" />

## Index Routes

`index.js`in folder `pages` will automatically become the default route `/`

i.e. pages/index.js -> `/`	pages/products/index.js -> `/products`

<img src="Next.js.assets/Screen Shot 2022-03-17 at 6.12.36 PM.png" alt="Screen Shot 2022-03-17 at 6.12.36 PM" style="zoom:50%;" />

## Nested Routes

Any nested files inside the `Pages` folder are essentially nested route

i.e. pages/products/phones.js -> `/products/phones`

## Dynamic Routes

To enable dynamic Routes, use brackets in the file name `[]`, whatever in the brackets becomes to a variable can be read by `{ useRouter }` from  `next/router`  through `query.id` attribute of router object created by `useRouter()`

i.e. pages/products/[id].js -> `/products/101`,`/products/102`......

```js
import { useRouter } from "next/router";

const Products = () => {
  const router = useRouter();
  return <div>Products id: {router.query.id}</div>;
};

export default Products;
```

Above code will show "Products id: 123" on page  when user access url `/products/123`

## Add route using Link component

<img src="Next.js.assets/Screen Shot 2022-03-18 at 12.59.55 PM.png" alt="Screen Shot 2022-03-18 at 12.59.55 PM" style="zoom:50%;" />

`<a>`will refresh the page, `<Link>`won't

```jsx
import Link from 'next/link';

export default () => {
  return (
    <div>
      <Link href='/'><a>Back to home</a></Link> 
    </div>
  );
}
```

Note: Remember to wrap the `<a>`, don't use `<Link>` only.

### Link props

`Link` accepts the following props:

- `href` - The path or URL to navigate to. This is the only required prop
- `as` - Optional decorator for the path that will be shown in the browser URL bar. Before Next.js 9.5.3 this was used for dynamic routes, check our [previous docs](https://nextjs.org/docs/tag/v9.5.2/api-reference/next/link#dynamic-routes) to see how it worked. Note: when this path differs from the one provided in `href` the previous `href`/`as` behavior is used as shown in the [previous docs](https://nextjs.org/docs/tag/v9.5.2/api-reference/next/link#dynamic-routes).
- [`passHref`](https://nextjs.org/docs/api-reference/next/link#if-the-child-is-a-custom-component-that-wraps-an-a-tag) - Forces `Link` to send the `href` property to its child. Defaults to `false`
- `prefetch` - Prefetch the page in the background. Defaults to `true`. Any `<Link />` that is in the viewport (initially or through scroll) will be preloaded. Prefetch can be disabled by passing `prefetch={false}`. When `prefetch` is set to `false`, prefetching will still occur on hover. Pages using [Static Generation](https://nextjs.org/docs/basic-features/data-fetching/get-static-props) will preload `JSON` files with the data for faster page transitions. Prefetching is only enabled in production.
- [`replace`](https://nextjs.org/docs/api-reference/next/link#replace-the-url-instead-of-push) - Replace the current `history` state instead of adding a new url into the stack. Defaults to `false`
- [`scroll`](https://nextjs.org/docs/api-reference/next/link#disable-scrolling-to-the-top-of-the-page) - Scroll to the top of the page after a navigation. Defaults to `true`
- [`shallow`](https://nextjs.org/docs/routing/shallow-routing) - Update the path of the current page without rerunning [`getStaticProps`](https://nextjs.org/docs/basic-features/data-fetching/get-static-props), [`getServerSideProps`](https://nextjs.org/docs/basic-features/data-fetching/get-server-side-props) or [`getInitialProps`](https://nextjs.org/docs/api-reference/data-fetching/get-initial-props). Defaults to `false`
- `locale` - The active locale is automatically prepended. `locale` allows for providing a different locale. When `false` `href` has to include the locale as the default behavior is disabled.

# Image Component

Next.js by default lazy load all of the images on the page. As user scroll down, Next.js will download the image that about to show.

# Document in Next.js

`_app.js` is only responsible for `<body>` . To handle whatever outside the body, like `<html>` and  `<head>`, we use `Document`

Create `_document.js` in `/pages`

Create a class `MyDocument extends Document` from 'next/document'

```js
import Document, { Html, Head, Main, NextScript } from "next/document";

class MyDocument extends Document {
  static async getInitialProps(ctx) {
    const initialProps = await Document.getInitialProps(ctx);
    return { ...initialProps };
  }

  render() {
    return (
      <Html>
        <Head />
        <body>
          <Main />
          <NextScript />
        </body>
      </Html>
    );
  }
}

export default MyDocument;
```

Note: `<Head>` Component here will be applied to all the pages in our app

`<Main>`Component responsible for the outest `div` in our app, add id on it: `<div id="__next">`

`<NextScript>`Component responsible for adding all of the scripts in our app

Develop Note: Each time when we changes `_document.js` we need to restart the server

## Apply fonts in Document

There are several ways you can setup fonts in Next.js.

1. You can choose to download those fonts, store them in your project and then apply those in your code.
2. You can download those directly from Google Fonts, set them inside _document.js without having to store them locally in your project for example,[ check the docs](https://nextjs.org/docs/basic-features/font-optimization)

For the second way, copy the font files into `/public/fonts/`, then we need to add `<link>` in `_document.js`:

#### _document.js

```jsx
<Head>
  <link
    rel="preload"
    href="/fonts/IBMPlexSans-Bold.ttf"
    as="font"
    crossOrigin="anonymous"
  />
  <link
    rel="preload"
    href="/fonts/IBMPlexSans-Regular.ttf"
    as="font"
    crossOrigin="anonymous"
  />
  <link
    rel="preload"
    href="/fonts/IBMPlexSans-SemiBold.ttf"
    as="font"
    crossOrigin="anonymous"
  />
 </Head>
```

<img src="Next.js.assets/Screen Shot 2022-03-18 at 1.00.57 PM.png" alt="Screen Shot 2022-03-18 at 1.00.57 PM" style="zoom:50%;" />

#### globals.css

```css
body {
	font-family: IMBPlexSans, //other fonts
}
@font-face {
  font-family: 'IBMPlexSans';
  font-style: normal;
  font-weight: 500;
  src: url(/fonts/IBMPlexSans-Regular.ttf) format('truetype');
}

@font-face {
  font-family: 'IBMPlexSans';
  font-style: normal;
  font-weight: 600;
  src: url(/fonts/IBMPlexSans-SemiBold.ttf) format('truetype');
}

@font-face {
  font-family: 'IBMPlexSans';
  font-style: normal;
  font-weight: 700;
  src: url(/fonts/IBMPlexSans-Bold.ttf) format('truetype');
}
```

# SEO and Rendering Techniques

<img src="Next.js.assets/Screen Shot 2022-03-18 at 11.59.35 AM.png" alt="Screen Shot 2022-03-18 at 11.59.35 AM" style="zoom:50%;" />

### Indexing

<img src="Next.js.assets/Screen Shot 2022-03-18 at 12.08.21 PM.png" alt="Screen Shot 2022-03-18 at 12.08.21 PM" style="zoom:50%;" />

### Analysis

<img src="Next.js.assets/Screen Shot 2022-03-18 at 1.01.55 PM.png" alt="Screen Shot 2022-03-18 at 1.01.55 PM" style="zoom:50%;" />

## Next.js Pre-rendering

<img src="Next.js.assets/Screen Shot 2022-03-18 at 12.18.59 PM.png" alt="Screen Shot 2022-03-18 at 12.18.59 PM" style="zoom:50%;" />

<img src="Next.js.assets/Screen Shot 2022-03-18 at 1.02.36 PM.png" alt="Screen Shot 2022-03-18 at 1.02.36 PM" style="zoom:50%;" />

The key difference is, Next.js app can show user the content  before JS loads. 

That means bots can read the content of the page much quicker.

## Rendering Techniques in Next.js

<img src="Next.js.assets/Screen Shot 2022-03-18 at 2.20.31 PM.png" alt="Screen Shot 2022-03-18 at 2.20.31 PM" style="zoom:50%;" />

### Static Generation (SSG)

<img src="Next.js.assets/Screen Shot 2022-03-18 at 1.19.01 PM.png" alt="Screen Shot 2022-03-18 at 1.19.01 PM" style="zoom:50%;" />

When user access our website, no new file generated.

All pages without external data will be defaultly pre-rendered.

Pages with external data will fetch the data first(inside `getStaticProps()` function) then pre-rendered

#### getStaticProps

<img src="Next.js.assets/Screen Shot 2022-03-19 at 11.56.36 AM.png" alt="Screen Shot 2022-03-19 at 11.56.36 AM" style="zoom:50%;" />

Everything inside `getStaticProps()` will be server side code. i.e. `console.log()` will be shown in server terminal

<img src="Next.js.assets/Screen Shot 2022-03-19 at 11.58.04 AM.png" alt="Screen Shot 2022-03-19 at 11.58.04 AM" style="zoom:40%;" />

```react
export async function getStaticProps(context) {
  //fetch data here
  const data = fetch('blahblah')
  return {
    props: {
      data
    }, // will be passed to the page component as props
  };
}

export default function Home(props) {
	console.log(props.data)
  //-----------
}
```

#### getStaticPahts

<img src="Next.js.assets/Screen Shot 2022-03-19 at 12.57.55 PM.png" alt="Screen Shot 2022-03-19 at 12.57.55 PM" style="zoom:50%;" />

<img src="Next.js.assets/Screen Shot 2022-03-19 at 12.58.58 PM.png" alt="Screen Shot 2022-03-19 at 12.58.58 PM" style="zoom:40%;" />

```react
export const getStaticProps = async (staticProps) => {
  const params = staticProps.params;
  return {
    props: {
      coffeeStore: coffeeStoresData.find((coffeeStore) => {
        return coffeeStore.id.toString() === params.id;
      }),
    },
  };
};

export const getStaticPaths = async () => {
  return {
    paths: [{ params: { id: "0" } }, { params: { id: "1" } }],
    fallback: false,
  };
};

const CoffeeStore = (props) => {
  const router = useRouter();
  return (
    <div>
      CoffeeStore {router.query.id}
      <Link href="/">
        <a>Back to home</a>
      </Link>
      <p>{props.coffeeStore.id}</p>
      <p>{props.coffeeStore.name}</p>
    </div>
  );
};
```

#### fallback: false

<img src="Next.js.assets/Screen Shot 2022-03-19 at 1.28.26 PM.png" alt="Screen Shot 2022-03-19 at 1.28.26 PM" style="zoom:60%;" />

Note: `getStaticPaths()` tells server the "static path" to be pre-rendered

`fallback: false` will redirect any routes doesn't exist in `getStaticPaths()` to 404 page.

#### fallback: true

<img src="Next.js.assets/Screen Shot 2022-03-19 at 1.41.36 PM.png" alt="Screen Shot 2022-03-19 at 1.41.36 PM" style="zoom:50%;" />

When user access a route does not in `getStaticPaths()`,  server will treat this route not "static pre-rendered" and try to download the page to the client. 

In case above, server give error because it needs time to access the data, however meanwhile the render is already begin rendering the page and failed to get `props.coffeeStore.id`

To prevent error above, we need to add a loading function by`{ useRouter }` from  `next/router`

<img src="Next.js.assets/Screen Shot 2022-03-19 at 1.51.20 PM.png" alt="Screen Shot 2022-03-19 at 1.51.20 PM" style="zoom:50%;" />

```react
const CoffeeStore = (props) => {
  const router = useRouter();

  //router.isFallback tells us if the newly download data is ready or not
  if (router.isFallback) {
    return <h1>Loading...</h1>;
  }

  return (
    <div>
      CoffeeStore {router.query.id}
      <Link href="/">
        <a>Back to home</a>
      </Link>
      <p>{props.coffeeStore.id}</p>
      <p>{props.coffeeStore.name}</p>
    </div>
  );
};
```

### Incremental Site Regeration (ISR)

<img src="Next.js.assets/Screen Shot 2022-03-18 at 2.21.45 PM.png" alt="Screen Shot 2022-03-18 at 2.21.45 PM" style="zoom:50%;" />

We set an interval. i.e. 60s. When user first request to our page, we only serve the cached one(v1) no matter how many times user send new requests. Untill 60s passed, server will generate the latest page when user request.

### Server-side rendering (SSR)

Applying this when we need to provide user the latest data timely. i.e. news(we want user see the latest news every time). We won't be able to cache data on CDN. We also need to generate page for each request. These make the process slower

### Client-side rendering (CSR)

<img src="Next.js.assets/Screen Shot 2022-03-18 at 2.39.19 PM.png" alt="Screen Shot 2022-03-18 at 2.39.19 PM" style="zoom:50%;" />

i.e. personal dashboard. administration software

`SWR` is a React hook built by Next.js. Very useful for client side fetching

# Environment Variables in Next.js

## Client side environment variables

To add environment variables to the JavaScript bundle, open `next.config.js` and add the `env` config:

```js
module.exports = {
  env: {
    customKey: 'my-value',
  },
}
```

Now you can access `process.env.customKey` in your code. For example:

```jsx
function Page() {
  return <h1>The value of customKey is: {process.env.customKey}</h1>
}

export default Page
```

Next.js will replace `process.env.customKey` with `'my-value'` at build time. Trying to destructure `process.env` variables won't work due to the nature of webpack [DefinePlugin](https://webpack.js.org/plugins/define-plugin/).

For example, the following line:

```jsx
return <h1>The value of customKey is: {process.env.customKey}</h1>
```

Will end up being:

```jsx
return <h1>The value of customKey is: {'my-value'}</h1>
```

## Server side environment variables

Next.js has built-in support for loading environment variables from `.env.local` into `process.env`.

An example `.env.local`:

```bash
DB_HOST=localhost
DB_USER=myuser
DB_PASS=mypassword
```

This loads `process.env.DB_HOST`, `process.env.DB_USER`, and `process.env.DB_PASS` into the Node.js environment automatically allowing you to use them in [Next.js data fetching methods](https://nextjs.org/docs/basic-features/data-fetching/overview) and [API routes](https://nextjs.org/docs/api-routes/introduction).

For example, using [`getStaticProps`](https://nextjs.org/docs/basic-features/data-fetching/get-static-props):

```js
// pages/index.js
export async function getStaticProps() {
  const db = await myDB.connect({
    host: process.env.DB_HOST,
    username: process.env.DB_USER,
    password: process.env.DB_PASS,
  })
  // ...
}
```

### Exposing Environment Variables to the Browser

By default environment variables are only available in the Node.js environment, meaning they won't be exposed to the browser.

In order to expose a variable to the browser you have to prefix the variable with `NEXT_PUBLIC_`. For example:

```bash
NEXT_PUBLIC_ANALYTICS_ID=abcdefghijk
```

This loads `process.env.NEXT_PUBLIC_ANALYTICS_ID` into the Node.js environment automatically, allowing you to use it anywhere in your code. The value will be inlined into JavaScript sent to the browser because of the `NEXT_PUBLIC_` prefix. This inlining occurs at build time, so your various `NEXT_PUBLIC_` envs need to be set when the project is built.

```js
// pages/index.js
import setupAnalyticsService from '../lib/my-analytics-service'

// NEXT_PUBLIC_ANALYTICS_ID can be used here as it's prefixed by NEXT_PUBLIC_
setupAnalyticsService(process.env.NEXT_PUBLIC_ANALYTICS_ID)

function HomePage() {
  return <h1>Hello World</h1>
}

export default HomePage
```